<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Dataset</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
      }
      section {
        margin-bottom: 1rem;
      }
      .section-header {
        font-size: 1.25rem;
        margin: 0.25rem 0;
      }
      #actionList {
        display: flex;
        gap: 0.5rem;
      }
      #actionList button {
        padding: 0.25rem 0.5rem;
      }
      #statsList {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem 0;
      }
      #statsList table {
        margin-inline-start: 1rem;
      }
      #classifiedList [data-text='className'],
      #unclassifiedList [data-text='className'] {
        font-weight: bold;
        margin: 0.25rem 0;
      }
      .img-list {
        display: flex;
        flex-wrap: wrap;
      }
      #classifiedList .img-list {
        line-height: 0;
      }
      .img-list img {
        width: 200px;
        height: 200px;
        object-fit: contain;
        padding: 5px;
        --border: 5px;
        --top: transparent;
        --bottom: transparent;
        background-size: var(--border) 100%;
        background-position: 0 0, 100% 0;
        background-repeat: no-repeat;
        border-top: var(--border) solid var(--top);
        border-bottom: var(--border) solid var(--bottom);
        background-image: linear-gradient(var(--top), var(--bottom)),
          linear-gradient(var(--top), var(--bottom));
      }
      .img-list img.selected {
        --top: #47c465;
        --bottom: #00deff;
      }
      .class-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .class-item {
      }
      #correctClassDialog {
        position: sticky;
        bottom: 1rem;
        margin: auto;
        padding: 1rem;
        border-radius: 1rem;
        border: 1px solid black;
        background-color: #fffa;
        backdrop-filter: blue(3px);
        width: fit-content;
      }
    </style>
  </head>
  <body>
    <template data-name="button">
      <button data-text="text" data-onclick="onclick"></button>
    </template>
    <section>
      <div class="section-header">Actions</div>
      <div id="actionList" data-template="button" data-bind="actions">
        loading...
      </div>
      <div id="actionResult"></div>
    </section>
    <section>
      <div class="section-header">Stats</div>
      <button onclick="loadStats()">reload</button>
      <div id="statsList" hidden>
        <div>
          dataset:
          <table>
            <thead>
              <th>count</th>
              <th>label</th>
            </thead>
            <tbody>
              <tr data-value="dataset">
                <td data-text="count"></td>
                <td data-text="className"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          classified:
          <table>
            <thead>
              <th>count</th>
              <th>label</th>
            </thead>
            <tbody>
              <tr data-value="classified">
                <td data-text="count"></td>
                <td data-text="className"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          unclassified: <span data-text="unclassified">loading...</span>
        </div>
      </div>
    </section>
    <section>
      <div class="section-header">Unclassified</div>
      <button onclick="loadUnclassified()">reload</button>
      <div
        id="unclassifiedList"
        data-template="unclassified"
        data-bind="classes"
      >
        (not auto loaded)
      </div>
      <template data-name="unclassified">
        <div class="unclassified">
          <div data-text="className"></div>
          <details>
            <summary><span data-text="count"></span> images</summary>
            <div class="img-list">
              <div data-value="images">
                <img
                  data-src="src"
                  loading="lazy"
                  onclick="toggleImage(event)"
                />
                <div class="class-list">
                  <div data-value="results" class="class-item">
                    <div data-text="label"></div>
                    <div data-text="confidence"></div>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </div>
      </template>
    </section>
    <section>
      <div class="section-header">Classified</div>
      <button onclick="loadClassified()">reload</button>
      <div id="classifiedList" data-template="classified" data-bind="classes">
        loading...
      </div>
      <template data-name="classified">
        <div class="classified">
          <div data-text="className"></div>
          <details>
            <summary><span data-text="count"></span> images</summary>
            <div class="img-list">
              <div data-value="images">
                <img
                  data-src="src"
                  loading="lazy"
                  onclick="toggleImage(event)"
                />
              </div>
            </div>
          </details>
        </div>
      </template>
    </section>
    <div id="correctClassDialog">
      <div class="section-header">
        Correct Label (<span id="correctCount">0</span>)
      </div>
      <div id="correctList" data-template="button" data-bind="buttons"></div>
      <div id="correctResult"></div>
    </div>
    <script src="/data-template/base.js"></script>
    <script>
      async function get(url, doneFn) {
        let res = await fetch(url)
        let json = await res.json()
        doneFn(json)
      }

      get('/actions', json => {
        actionList.textContent = ''
        renderTemplate(actionList, {
          actions: json.actions.map(action => {
            let name = action[0].toUpperCase() + action.slice(1)
            return {
              text: name,
              async onclick(event) {
                let button = event.currentTarget
                button.textContent = name + ' (running...)'
                let res = await fetch('/' + action, { method: 'POST' })
                let json = await res.json()
                if (json.error) {
                  button.textContent = name + ' (error)'
                  actionResult.textContent = json.error
                  return
                }
                button.textContent = name + ' (done)'
                actionResult.textContent = ''
                loadStats()
              },
            }
          }),
        })
      })

      function loadStats() {
        statsList.querySelectorAll('tbody').forEach(tbody => {
          for (;;) {
            let row = tbody.rows[1]
            if (row) {
              row.remove()
            } else {
              break
            }
          }
          tbody.rows[0].cells[0].textContent = 'loading...'
          tbody.rows[0].cells[1].textContent = ''
        })
        get('/stats', json => {
          renderData(statsList, json.stats)
          statsList.hidden = false
          let classNames = Array.from(
            new Set([
              ...json.stats.dataset.map(item => item.className),
              ...json.stats.classified.map(item => item.className),
            ]),
          )
          renderTemplate(correctList, {
            buttons: classNames.map(className => {
              return {
                text: className,
                async onclick(event) {
                  let button = event.currentTarget
                  button.textContent = className + ' (correcting...)'
                  let selectedImgs = document.querySelectorAll(
                    '#classifiedList .selected, #unclassifiedList .selected',
                  )
                  let images = Array.from(selectedImgs, img =>
                    img.getAttribute('src'),
                  )
                  let res = await fetch('/correct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      className,
                      images,
                    }),
                  })
                  let json = await res.json()
                  if (json.error) {
                    button.textContent = className + ' (error)'
                    correctResult.textContent = json.error
                    return
                  }
                  button.textContent = className + ' (done)'
                  correctResult.textContent = ''
                  correctCount.textContent = 0
                  for (let img of selectedImgs) {
                    img.parentElement.remove()
                  }
                  document
                    .querySelectorAll(
                      '#classifiedList .classified, #unclassifiedList .unclassified',
                    )
                    .forEach(div => {
                      div.querySelector('[data-text="count"]').textContent =
                        div.querySelectorAll('img').length
                    })
                },
              }
            }),
          })
        })
      }
      loadStats()

      function toggleImage(event) {
        let img = event.currentTarget
        if (!img.classList.contains('selected')) {
          img.classList.add('selected')
          correctCount.textContent++
        } else {
          img.classList.remove('selected')
          correctCount.textContent--
        }
      }

      function loadUnclassified() {
        unclassifiedList.textContent = 'loading...'
        get('/unclassified', json => {
          renderTemplate(unclassifiedList, {
            classes: json.classes.map(({ className, images }) => ({
              className,
              count: images.length,
              images: images
                .sort((a, b) => a.confidence - b.confidence)
                .map(image => ({
                  ...image,
                  src: `/unclassified/${image.filename}`,
                  results: image.results
                    .sort((a, b) => b.confidence - a.confidence)
                    .map(result => ({
                      label: result.label,
                      confidence: (result.confidence * 100).toFixed(2) + '%',
                    })),
                })),
            })),
          })
        })
      }

      function loadClassified() {
        classifiedList.textContent = 'loading...'
        get('/classified', json => {
          renderTemplate(classifiedList, {
            classes: json.classes.map(({ className, filenames }) => {
              return {
                className,
                count: filenames.length,
                images: filenames.map(filename => ({
                  src: `/classified/${className}/${filename}`,
                })),
              }
            }),
          })
        })
      }
      loadClassified()
    </script>
  </body>
</html>
